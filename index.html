<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MF Investment Tracker</title>
    <style>
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(33, 128, 141, 1);
          --color-teal-600: rgba(29, 116, 128, 1);
          --color-teal-700: rgba(26, 104, 115, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);

          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;

          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-teal-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
          --color-profit: #10b981;
          --color-loss: #ef4444;

          /* Common style patterns */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

          /* Typography */
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
            BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-size-base: 14px;
          --font-size-sm: 12px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;

          /* Spacing */
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;

          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-lg: 12px;
          --radius-full: 9999px;

          /* Shadows */
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
            0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
            0 4px 6px -2px rgba(0, 0, 0, 0.02);
          
          /* Animation */
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

          /* Layout */
          --container-xl: 1280px;
        }

        /* Dark mode colors */
        @media (prefers-color-scheme: dark) {
          :root {
            --color-gray-400-rgb: 119, 124, 124;
            --color-teal-300-rgb: 50, 184, 198;
            --color-gray-300-rgb: 167, 169, 169;
            --color-gray-200-rgb: 245, 245, 245;

            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-teal-300);
            --color-primary-hover: var(--color-teal-400);
            --color-primary-active: var(--color-teal-800);
            --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
            --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
            --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
            --color-border: rgba(var(--color-gray-400-rgb), 0.3);
            --color-error: var(--color-red-400);
            --color-success: var(--color-teal-300);
            --color-warning: var(--color-orange-400);
            --color-info: var(--color-gray-300);
            --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
            --color-btn-primary-text: var(--color-slate-900);
            --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
          }
        }

        /* Base styles */
        html {
          font-family: var(--font-family-base);
          color: var(--color-text);
          background-color: var(--color-background);
          -webkit-font-smoothing: antialiased;
          box-sizing: border-box;
        }

        body {
          margin: 0;
          padding: 0;
          min-height: 100vh;
        }

        *,
        *::before,
        *::after {
          box-sizing: inherit;
        }
        
        h1, h2, h3, h4 {
          margin: 0;
          font-weight: var(--font-weight-semibold);
          line-height: var(--line-height-tight);
          letter-spacing: var(--letter-spacing-tight);
        }
        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-3xl); }
        h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); }
        p { margin: 0; }

        /* Layout */
        .container {
          width: 100%;
          max-width: var(--container-xl);
          margin: 0 auto;
          padding: var(--space-24);
        }
        .header {
          text-align: center;
          margin-bottom: var(--space-32);
        }
        .header h1 {
          margin-bottom: var(--space-8);
        }
        .subtitle {
          color: var(--color-text-secondary);
          font-size: var(--font-size-lg);
        }

        /* Summary Cards */
        .summary-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: var(--space-16);
          margin-bottom: var(--space-32);
        }
        .summary-card {
          background: var(--color-surface);
          border: 1px solid var(--color-card-border);
          border-radius: var(--radius-lg);
          padding: var(--space-20);
          text-align: center;
          box-shadow: var(--shadow-sm);
        }
        .summary-label {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
          margin-bottom: var(--space-8);
          font-weight: var(--font-weight-medium);
        }
        .summary-value {
          font-size: var(--font-size-3xl);
          font-weight: var(--font-weight-bold);
        }
        .summary-value.positive { color: var(--color-profit); }
        .summary-value.negative { color: var(--color-loss); }

        /* Action Bar & Filters */
        .action-bar {
          display: flex;
          gap: var(--space-12);
          margin-bottom: var(--space-24);
          flex-wrap: wrap;
        }
        .search-filter-section {
          background: var(--color-surface);
          border: 1px solid var(--color-card-border);
          border-radius: var(--radius-lg);
          padding: var(--space-20);
          margin-bottom: var(--space-24);
          box-shadow: var(--shadow-sm);
        }
        .search-input-wrapper {
          position: relative;
          max-width: 500px;
          margin-bottom: var(--space-16);
        }
        .search-icon {
          position: absolute;
          left: var(--space-12);
          top: 50%;
          transform: translateY(-50%);
          color: var(--color-text-secondary);
          pointer-events: none;
        }
        .search-input {
          width: 100%;
          padding: var(--space-10) var(--space-12) var(--space-10) var(--space-32);
          font-size: var(--font-size-base);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          background: var(--color-background);
          color: var(--color-text);
        }
        .clear-search {
          position: absolute;
          right: var(--space-8);
          top: 50%;
          transform: translateY(-50%);
          background: none; border: none; font-size: var(--font-size-lg);
          color: var(--color-text-secondary); cursor: pointer;
        }
        .filter-controls {
          display: flex; gap: var(--space-16); align-items: end; flex-wrap: wrap;
        }
        .filter-group {
          display: flex; flex-direction: column; gap: var(--space-6); min-width: 120px;
        }
        .filter-label {
          font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);
        }
        .filter-select {
          padding: var(--space-8) var(--space-12); border: 1px solid var(--color-border);
          border-radius: var(--radius-base); background: var(--color-background);
          color: var(--color-text); font-size: var(--font-size-sm);
          -webkit-appearance: none; appearance: none;
          background-image: var(--select-caret-light);
          background-repeat: no-repeat;
          background-position: right var(--space-8) center;
          background-size: 14px; padding-right: var(--space-24);
        }
        @media (prefers-color-scheme: dark) { .filter-select { background-image: var(--select-caret-dark); } }
        .active-filters {
          display: flex; gap: var(--space-8); margin-bottom: var(--space-16); flex-wrap: wrap;
        }
        .filter-chip {
          display: inline-flex; align-items: center; gap: var(--space-6);
          padding: var(--space-4) var(--space-8); background: var(--color-primary);
          color: var(--color-btn-primary-text); border-radius: var(--radius-full);
          font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);
        }
        .filter-chip-remove {
          background: none; border: none; color: inherit; cursor: pointer;
          font-size: var(--font-size-lg); line-height: 1;
        }
        .results-count {
          font-size: var(--font-size-sm); color: var(--color-text-secondary);
          margin-bottom: var(--space-16); font-weight: var(--font-weight-medium);
        }

        /* Buttons */
        .btn {
          display: inline-flex; align-items: center; justify-content: center;
          gap: var(--space-8); padding: var(--space-10) var(--space-16);
          border-radius: var(--radius-base); font-size: var(--font-size-base);
          font-weight: var(--font-weight-medium); cursor: pointer;
          transition: all var(--duration-normal) var(--ease-standard);
          border: none; text-decoration: none;
        }
        .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
        .btn--primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
        .btn--primary:hover { background: var(--color-primary-hover); }
        .btn--secondary { background: var(--color-secondary); color: var(--color-text); }
        .btn--secondary:hover { background: var(--color-secondary-hover); }
        .btn--outline { background: transparent; border: 1px solid var(--color-border); color: var(--color-text); }
        .btn--outline:hover { background: var(--color-secondary); }
        .btn--sm { padding: var(--space-4) var(--space-12); font-size: var(--font-size-sm); border-radius: var(--radius-sm); }

        /* Investments Grid */
        .investments-section h2 { margin-bottom: var(--space-24); }
        .investments-grid { display: grid; gap: var(--space-16); }
        .investment-card {
          background: var(--color-surface); border: 1px solid var(--color-card-border);
          border-radius: var(--radius-lg); padding: var(--space-20);
          box-shadow: var(--shadow-sm); transition: box-shadow var(--duration-normal) var(--ease-standard);
        }
        .investment-card:hover { box-shadow: var(--shadow-md); }
        .investment-header {
          display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);
        }
        .investment-info h4 { margin-bottom: var(--space-4); }
        .investment-meta {
          font-size: var(--font-size-sm); color: var(--color-text-secondary);
          display: flex; flex-wrap: wrap; gap: var(--space-12);
        }
        .investment-actions { display: flex; gap: var(--space-8); }
        .investment-stats {
          display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          gap: var(--space-16);
        }
        .stat-item { text-align: center; }
        .stat-label {
          font-size: 11px; color: var(--color-text-secondary); margin-bottom: var(--space-4);
          text-transform: uppercase; font-weight: var(--font-weight-medium); letter-spacing: 0.05em;
        }
        .stat-value {
          font-size: var(--font-size-lg); font-weight: var(--font-weight-bold);
        }
        .stat-value.positive { color: var(--color-profit); }
        .stat-value.negative { color: var(--color-loss); }

        /* Empty State */
        .empty-state { text-align: center; padding: var(--space-32); color: var(--color-text-secondary); }
        .empty-icon { font-size: 48px; margin-bottom: var(--space-16); }

        /* Modal */
        .modal-overlay {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.5); display: flex;
          align-items: center; justify-content: center; z-index: 1000;
          opacity: 0; visibility: hidden;
          transition: all var(--duration-normal) var(--ease-standard);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
          background: var(--color-surface); border-radius: var(--radius-lg);
          box-shadow: var(--shadow-lg); width: 90%; max-width: 500px;
          max-height: 90vh; overflow-y: auto;
          transform: scale(0.9);
          transition: transform var(--duration-normal) var(--ease-standard);
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header {
          display: flex; justify-content: space-between; align-items: center;
          padding: var(--space-20); border-bottom: 1px solid var(--color-card-border-inner);
        }
        .modal-close {
          background: none; border: none; font-size: var(--font-size-2xl); cursor: pointer;
          color: var(--color-text-secondary);
        }
        .modal-body { padding: var(--space-20); }
        .modal-footer {
          display: flex; justify-content: flex-end; gap: var(--space-12);
          padding: var(--space-20); border-top: 1px solid var(--color-card-border-inner);
        }
        #confirmModal .modal-footer {
            padding-top: 0;
            border-top: none;
        }

        /* Form Elements inside Modal */
        .form-group { margin-bottom: var(--space-16); }
        .form-label {
          display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }
        .form-control {
          display: block; width: 100%; padding: var(--space-10) var(--space-12);
          font-size: var(--font-size-base); color: var(--color-text);
          background-color: var(--color-surface); border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
        }
        select.form-control {
          -webkit-appearance: none; appearance: none;
          background-image: var(--select-caret-light); background-repeat: no-repeat;
          background-position: right var(--space-12) center; background-size: 16px;
          padding-right: var(--space-32);
        }
        @media (prefers-color-scheme: dark) { select.form-control { background-image: var(--select-caret-dark); } }
        .form-hint { font-size: 11px; color: var(--color-text-secondary); margin-top: var(--space-4); }
        .radio-group { display: flex; gap: var(--space-16); }
        .radio-option { display: flex; align-items: center; gap: var(--space-8); cursor: pointer; }
        .radio-option input[type="radio"] { opacity: 0; width: 0; height: 0; }
        .radio-custom {
          width: 16px; height: 16px; border: 2px solid var(--color-border);
          border-radius: 50%; position: relative;
        }
        .radio-option input[type="radio"]:checked + .radio-custom {
          border-color: var(--color-primary); background: var(--color-primary);
        }
        .radio-option input[type="radio"]:checked + .radio-custom::after {
          content: ''; position: absolute; top: 50%; left: 50%;
          width: 6px; height: 6px; background: white; border-radius: 50%;
          transform: translate(-50%, -50%);
        }

        /* Fund Details & Preview */
        .fund-details, .units-preview, .installments-breakdown {
          border-radius: var(--radius-base); padding: var(--space-16); margin-bottom: var(--space-16);
        }
        .fund-details { background: #dbeafe; border: 1px solid #93c5fd; }
        .fund-details h4 { color: #1e40af; margin-bottom: var(--space-8); }
        .fund-details p { margin: var(--space-4) 0; font-size: var(--font-size-sm); }
        .units-preview { background: #dcfce7; border: 1px solid #86efac; }
        .units-preview h4 { color: #166534; margin-bottom: var(--space-12); }
        .preview-grid { display: flex; flex-direction: column; gap: var(--space-12); }
        .preview-label { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); margin-bottom: var(--space-4); }
        .preview-value { font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); margin-bottom: var(--space-4); }
        .preview-note { font-size: 11px; opacity: 0.8; }
        .installments-breakdown { background: #e0e7ff; border: 1px solid #a5b4fc; }
        .installments-breakdown h4 { color: #3730a3; margin-bottom: var(--space-16); }
        .breakdown-summary { margin-bottom: var(--space-16); }
        .summary-item { display: flex; justify-content: space-between; align-items: center; }
        .summary-label { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); }
        .summary-value { font-size: var(--font-size-base); font-weight: var(--font-weight-bold); }
        .installments-list { max-height: 200px; overflow-y: auto; }
        .installment-item {
          display: grid; grid-template-columns: 1fr auto auto; gap: var(--space-12); align-items: center;
          padding: var(--space-8); border-radius: var(--radius-sm); margin-bottom: var(--space-6); font-size: var(--font-size-sm);
        }
        
        /* Loading & Toast */
        .loading-overlay {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.3); display: flex; align-items: center;
          justify-content: center; z-index: 2000; opacity: 0; visibility: hidden;
          transition: all var(--duration-normal) var(--ease-standard);
        }
        .loading-overlay.active { opacity: 1; visibility: visible; }
        .loading-spinner {
          background: var(--color-surface); padding: var(--space-32);
          border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-lg);
        }
        .spinner {
          width: 40px; height: 40px; border: 4px solid var(--color-secondary);
          border-top: 4px solid var(--color-primary); border-radius: 50%;
          animation: spin 1s linear infinite; margin: 0 auto var(--space-16);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast-container {
          position: fixed; top: var(--space-20); right: var(--space-20);
          z-index: 3000; display: flex; flex-direction: column; gap: var(--space-8);
        }
        .toast {
          background: var(--color-surface); border: 1px solid var(--color-card-border);
          border-radius: var(--radius-base); padding: var(--space-12) var(--space-16);
          box-shadow: var(--shadow-md); min-width: 300px; transform: translateX(100%);
          transition: transform var(--duration-normal) var(--ease-standard);
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--color-success); }
        .toast.error { border-left: 4px solid var(--color-error); }
        .toast-content { display: flex; align-items: center; gap: var(--space-8); }

        /* Badge */
        .badge {
            display: inline-block; padding: var(--space-4) var(--space-8); border-radius: var(--radius-full);
            font-size: 11px; font-weight: var(--font-weight-medium); text-transform: uppercase;
        }
        .badge--sip { background: #dbeafe; color: #1e40af; }
        .badge--lumpsum { background: #fee2e2; color: #991b1b; }

        /* Auth Screen */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .auth-box {
            background: var(--color-surface);
            padding: var(--space-32);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .auth-box h2 {
            margin-bottom: var(--space-16);
        }
        .auth-box p {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-24);
        }
        #login-btn {
            width: 100%;
        }
        #login-btn svg {
            margin-right: var(--space-8);
        }

        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            position: absolute;
            top: var(--space-24);
            right: var(--space-24);
        }
        .user-profile span {
            font-weight: var(--font-weight-medium);
        }

        @font-face {
          font-family: 'FKGroteskNeue';
          src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
        }
    </style>
</head>
<body>
    <!-- App Container -->
    <div id="app-container" style="display: none;">
        <div class="container">
            <!-- Header -->
            <header class="header">
                 <div class="user-profile" id="user-profile" style="display: none;">
                    <span id="user-name"></span>
                    <button class="btn btn--outline btn--sm" id="logout-btn">Logout</button>
                </div>
                <h1>Mutual Fund Investment Tracker</h1>
                <p class="subtitle">Track your SIP &amp; Lumpsum investments with real-time P&amp;L</p>
            </header>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">Total Invested</div>
                    <div class="summary-value" id="totalInvested">â‚¹0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Current Value</div>
                    <div class="summary-value" id="currentValue">â‚¹0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total P&L</div>
                    <div class="summary-value" id="totalPL">â‚¹0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total P&L %</div>
                    <div class="summary-value" id="totalPLPercent">0%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">XIRR</div>
                    <div class="summary-value" id="totalXIRR">0%</div>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="search-filter-section">
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by fund name, AMC, or AMFI code...">
                    <button id="clearSearch" class="clear-search" style="display: none;">&times;</button>
                </div>
                
                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">Type:</label>
                        <select id="typeFilter" class="filter-select">
                            <option value="">All Types</option><option value="SIP">SIP</option><option value="Lumpsum">Lumpsum</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Category:</label>
                        <select id="categoryFilter" class="filter-select">
                            <option value="">All Categories</option><option value="Equity">Equity</option><option value="Debt">Debt</option><option value="Hybrid">Hybrid</option><option value="Liquid">Liquid</option><option value="ELSS">ELSS</option><option value="Balanced">Balanced</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">AMC:</label>
                        <select id="amcFilter" class="filter-select"><option value="">All AMCs</option></select>
                    </div>
                    <button id="clearFilters" class="btn btn--outline btn--sm">Clear Filters</button>
                </div>
            </div>
            
            <div class="active-filters" id="activeFilters" style="display: none;"></div>
            <div class="results-count" id="resultsCount"></div>

            <!-- Action Buttons -->
            <div class="action-bar">
                <button class="btn btn--primary" id="addInvestmentBtn">Add Investment</button>
                <button class="btn btn--outline" id="exportDataBtn">Export Data</button>
                <label class="btn btn--outline" for="importDataInput">Import Data</label>
                <input type="file" id="importDataInput" accept=".json" style="display: none;">
                <button class="btn btn--secondary" id="refreshNAVBtn">Refresh NAV</button>
            </div>

            <!-- Investments Section -->
            <div class="investments-section">
                <h2>Your Investments</h2>
                <div class="investments-grid" id="investmentsGrid">
                    <!-- Investment cards are rendered here by JavaScript -->
                </div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">ðŸ“Š</div>
                    <h3>No Investments Yet</h3>
                    <p>Add your first investment to start tracking your portfolio</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <div class="auth-box">
            <h2>Welcome to your MF Tracker</h2>
            <p>Sign in with your Google account to securely save and access your investments from any device.</p>
            <button class="btn btn--primary" id="login-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>


    <!-- Add/Edit Investment Modal -->
    <div class="modal-overlay" id="investmentModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Add Investment</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form class="modal-body" id="investmentForm">
                <div class="form-group">
                    <label class="form-label" for="amfiCode">AMFI Code *</label>
                    <input type="text" class="form-control" id="amfiCode" placeholder="e.g., 120503" required>
                    <div class="form-hint">Enter AMFI code to auto-fetch fund details.</div>
                </div>

                <div class="fund-details" id="fundDetails" style="display: none;">
                    <h4><span id="fundName">Fund Name</span></h4>
                    <p><strong>AMC:</strong> <span id="fundAMC">-</span> | <strong>Category:</strong> <span id="fundType">-</span></p>
                    <p><strong>Current NAV:</strong> â‚¹<span id="currentNAV">-</span></p>
                </div>

                <div class="form-group"><label class="form-label">Investment Type *</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="investmentType" value="SIP" checked><span class="radio-custom"></span>SIP</label>
                        <label class="radio-option"><input type="radio" name="investmentType" value="Lumpsum"><span class="radio-custom"></span>Lumpsum</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="amount">Investment Amount *</label>
                    <input type="number" class="form-control" id="amount" placeholder="5000" min="100" required>
                </div>

                <div class="units-preview" id="unitsPreview" style="display: none;">
                    <h4>Units Calculation Preview</h4>
                    <div class="preview-grid">
                         <div id="lumpsumUnitsPreview" style="display: none;">
                            <div class="preview-label">Units after Stamp Duty:</div>
                            <div class="preview-value" id="lumpsumUnitsValue">-</div>
                            <div class="preview-note">Based on NAV for selected date: â‚¹<span id="lumpsumNavDisplay">-</span></div>
                        </div>
                        <div id="firstPurchaseUnits" style="display: none;">
                            <div class="preview-label">First Purchase Units (Net):</div>
                            <div class="preview-value" id="firstUnitsValue">-</div>
                            <div class="preview-note">Based on NAV for selected date: â‚¹<span id="firstPurchaseNavDisplay">-</span></div>
                        </div>
                        <div id="sipUnitsPreview" style="display: none;">
                            <div class="preview-label">Est. Monthly Units (Net):</div>
                            <div class="preview-value" id="sipUnitsValue">-</div>
                             <div class="preview-note">Based on current NAV (for future installments)</div>
                        </div>
                        <div class="preview-note" style="text-align: center; margin-top: 8px; font-size: 11px;">
                            Units are calculated on the net amount after deducting 0.005% stamp duty.
                        </div>
                    </div>
                </div>

                <div class="sip-fields">
                    <div class="form-group"><label class="form-label" for="firstPurchaseDate">First Purchase Date *</label><input type="date" class="form-control" id="firstPurchaseDate" required></div>
                    <div class="form-group"><label class="form-label" for="sipDate">SIP Date *</label><select class="form-control" id="sipDate" required></select></div>
                    <div class="form-group"><label class="form-label" for="frequency">SIP Frequency *</label><select class="form-control" id="frequency" required><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option></select></div>
                </div>

                <div class="lumpsum-fields" style="display: none;">
                    <div class="form-group"><label class="form-label" for="purchaseDate">Purchase Date *</label><input type="date" class="form-control" id="purchaseDate"></div>
                </div>

                <div class="installments-breakdown" id="installmentsBreakdown" style="display: none;">
                    <h4>Installments Breakdown</h4>
                    <div class="breakdown-summary"><div class="summary-item"><span class="summary-label">Total Units:</span><span class="summary-value" id="currentTotalUnits">0.0000</span></div><div class="summary-item"><span class="summary-label">Current Value:</span><span class="summary-value" id="currentTotalValue">â‚¹0</span></div></div>
                    <div class="installments-list" id="installmentsList"></div>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn--outline" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn--primary" id="saveBtn">Save Investment</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirm Action</h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--outline" id="confirmCancelBtn">Cancel</button>
                <button type="button" class="btn btn--primary" id="confirmOkBtn">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Loading & Toast -->
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"><div class="spinner"></div><p>Please wait...</p></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // IMPORTANT: Replace with your Firebase project configuration
        // You can get this from the Firebase console
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyAPkhmeau8M_iJAgqXkbr_ItJ236wWN9iw",
          authDomain: "mf-trac.firebaseapp.com",
          databaseURL: "https://mf-trac-default-rtdb.firebaseio.com",
          projectId: "mf-trac",
          storageBucket: "mf-trac.firebasestorage.app",
          messagingSenderId: "608469802915",
          appId: "1:608469802915:web:aeeaee59c6afe70c04c416",
          measurementId: "G-4NW5ZCVFJ9"
        };
        
        // Investment Tracker App
        class InvestmentTracker {
            constructor() {
                this.investments = [];
                this.filteredInvestments = [];
                this.editingId = null;
                this.fundHistoricalData = null;
                this.previewNAV = null;
                this.confirmCallback = null;
                this.STAMP_DUTY_RATE = 0.00005; // 0.005%
                this.filters = { search: '', type: '', category: '', amc: '' };
                this.db = null;
                this.userId = null;
                this.unsubscribe = null; // To store the onSnapshot listener
            }

            async init(db, user) {
                this.db = db;
                this.userId = user.uid;

                this.setupEventListeners();
                this.populateSipDays();
                this._setupFirestoreListener(); // This will load data and trigger the first render
            }
            
            _setupFirestoreListener() {
                if (this.unsubscribe) this.unsubscribe(); // Unsubscribe from any previous listener

                const docRef = doc(this.db, "investments", this.userId);
                this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.investments = data.investments || [];
                    } else {
                        // If the document doesn't exist, it's a new user.
                        this.investments = [];
                    }
                    // Trigger a full UI update whenever data changes
                    this.updateAMCFilter();
                    this.applyFilters();
                    this.updateSummary();
                });
            }

            async _saveData() {
                if (!this.db || !this.userId) return;
                try {
                    const docRef = doc(this.db, "investments", this.userId);
                    await setDoc(docRef, { investments: this.investments });
                } catch (error) {
                    console.error("Error saving data to Firestore: ", error);
                    this.showToast("Could not save data to the cloud.", "error");
                }
            }


            populateSipDays() {
                const sipDateSelect = document.getElementById('sipDate');
                sipDateSelect.innerHTML = '<option value="">Select Day</option>';
                for (let i = 1; i <= 28; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    sipDateSelect.appendChild(option);
                }
            }

            setupEventListeners() {
                document.getElementById('addInvestmentBtn').addEventListener('click', () => this.openModal());
                document.getElementById('exportDataBtn').addEventListener('click', () => this.exportData());
                document.getElementById('importDataInput').addEventListener('change', (e) => this.importData(e.target.files[0]));
                document.getElementById('refreshNAVBtn').addEventListener('click', () => this.refreshAllNAV());

                // Modal controls
                const investmentModal = document.getElementById('investmentModal');
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('cancelBtn').addEventListener('click', () => this.closeModal());
                investmentModal.addEventListener('click', (e) => { if (e.target === investmentModal) this.closeModal(); });
                document.getElementById('investmentForm').addEventListener('submit', (e) => { e.preventDefault(); this.saveInvestment(); });
                
                document.getElementById('amfiCode').addEventListener('blur', (e) => { if (e.target.value) this.fetchFundDetails(e.target.value); });
                document.getElementById('amount').addEventListener('input', () => this.updateUnitsPreview());
                
                // Date inputs for dynamic NAV preview
                document.getElementById('purchaseDate').addEventListener('change', () => this.updatePreviewNav());
                document.getElementById('firstPurchaseDate').addEventListener('change', () => this.updatePreviewNav());


                document.querySelectorAll('input[name="investmentType"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.toggleInvestmentFields(e.target.value));
                });
                
                document.getElementById('confirmCancelBtn').addEventListener('click', () => this.closeConfirmModal());
                document.getElementById('confirmOkBtn').addEventListener('click', () => this.handleConfirm());

                // Filters
                document.getElementById('searchInput').addEventListener('input', (e) => { this.filters.search = e.target.value; this.applyFilters(); this.toggleClearSearch(); });
                document.getElementById('clearSearch').addEventListener('click', () => { document.getElementById('searchInput').value = ''; this.filters.search = ''; this.applyFilters(); this.toggleClearSearch(); });
                document.getElementById('typeFilter').addEventListener('change', (e) => { this.filters.type = e.target.value; this.applyFilters(); });
                document.getElementById('categoryFilter').addEventListener('change', (e) => { this.filters.category = e.target.value; this.applyFilters(); });
                document.getElementById('amcFilter').addEventListener('change', (e) => { this.filters.amc = e.target.value; this.applyFilters(); });
                document.getElementById('clearFilters').addEventListener('click', () => this.clearAllFilters());

                document.getElementById('investmentsGrid').addEventListener('click', (e) => {
                    const card = e.target.closest('.investment-card');
                    if (!card) return;
                    const id = card.dataset.id;
                    if (e.target.closest('.js-edit-btn')) this.handleEdit(id);
                    else if (e.target.closest('.js-delete-btn')) this.handleDelete(id);
                });
            }

            openModal(investment = null) {
                this.editingId = investment ? investment.id : null;
                document.getElementById('modalTitle').textContent = investment ? 'Edit Investment' : 'Add Investment';
                const form = document.getElementById('investmentForm');
                
                this.fundHistoricalData = null; // Reset historical data
                
                if (investment) {
                    this.populateForm(investment);
                    this.showInstallmentsBreakdown(investment);
                } else {
                    form.reset();
                    this.hideFundDetails();
                    this.hideUnitsPreview();
                    this.hideInstallmentsBreakdown();
                    this.toggleInvestmentFields('SIP');
                }
                document.getElementById('investmentModal').classList.add('active');
            }

            closeModal() {
                document.getElementById('investmentModal').classList.remove('active');
                this.editingId = null;
            }
            
            openConfirmModal(message, callback) {
                document.getElementById('confirmMessage').textContent = message;
                this.confirmCallback = callback;
                document.getElementById('confirmModal').classList.add('active');
            }

            closeConfirmModal() {
                document.getElementById('confirmModal').classList.remove('active');
                this.confirmCallback = null;
            }
            
            handleConfirm() {
                if (this.confirmCallback) this.confirmCallback();
                this.closeConfirmModal();
            }

            async populateForm(investment) {
                await this.fetchFundDetails(investment.amfiCode); // Fetch data for editing
                document.getElementById('amfiCode').value = investment.amfiCode;
                document.querySelector(`input[name="investmentType"][value="${investment.investmentType}"]`).checked = true;
                document.getElementById('amount').value = investment.amount;
                
                if (investment.investmentType === 'SIP') {
                    document.getElementById('firstPurchaseDate').value = investment.firstPurchaseDate;
                    document.getElementById('sipDate').value = investment.sipDate;
                    document.getElementById('frequency').value = investment.frequency;
                } else {
                    document.getElementById('purchaseDate').value = investment.purchaseDate;
                }
                this.toggleInvestmentFields(investment.investmentType);
                this.showFundDetails({
                    name: investment.fundName,
                    amc: investment.amc, 
                    type: investment.fundType,
                    currentNAV: investment.currentNAV || this.getNavForDate(new Date().toISOString().split('T')[0])
                });
            }

            toggleInvestmentFields(type) {
                document.querySelector('.sip-fields').style.display = type === 'SIP' ? 'block' : 'none';
                document.querySelector('.lumpsum-fields').style.display = type === 'Lumpsum' ? 'block' : 'none';
                document.getElementById('firstPurchaseDate').required = type === 'SIP';
                document.getElementById('sipDate').required = type === 'SIP';
                document.getElementById('purchaseDate').required = type === 'Lumpsum';
                this.updatePreviewNav();
            }

            async fetchFundDetails(amfiCode) {
                this.showLoading('Fetching fund details...');
                try {
                    const response = await fetch(`https://api.mfapi.in/mf/${amfiCode}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    if (data && data.meta && data.data && data.data.length > 0) {
                        this.fundHistoricalData = data.data;
                        const fundInfo = {
                            name: data.meta.scheme_name,
                            amc: data.meta.fund_house,
                            type: data.meta.scheme_category,
                            currentNAV: parseFloat(data.data[0].nav)
                        };
                        this.showFundDetails(fundInfo);
                        this.updatePreviewNav();
                    } else {
                        throw new Error('Invalid AMFI code or no data found');
                    }
                } catch (error) {
                    console.error('Error fetching fund details:', error);
                    this.showToast('Error fetching fund details.', 'error');
                    this.hideFundDetails();
                } finally {
                    this.hideLoading();
                }
            }

            getNavForDate(targetDateStr) {
                if (!this.fundHistoricalData || !targetDateStr) return null;

                const targetDate = new Date(targetDateStr + 'T00:00:00Z');
                targetDate.setUTCHours(0, 0, 0, 0);

                let closestNav = null;
                let closestDate = null;

                for (const record of this.fundHistoricalData) {
                    const [day, month, year] = record.date.split('-');
                    const recordDate = new Date(`${year}-${month}-${day}T00:00:00Z`);
                    
                    if (recordDate <= targetDate) {
                        if (!closestDate || recordDate > closestDate) {
                            closestDate = recordDate;
                            closestNav = parseFloat(record.nav);
                        }
                    }
                }
                return closestNav;
            }

            async updatePreviewNav() {
                if (!this.fundHistoricalData) return;
                const investmentType = document.querySelector('input[name="investmentType"]:checked').value;
                const dateStr = (investmentType === 'SIP') 
                    ? document.getElementById('firstPurchaseDate').value
                    : document.getElementById('purchaseDate').value;
                
                if (dateStr) {
                    this.previewNAV = this.getNavForDate(dateStr);
                } else {
                    this.previewNAV = null;
                }
                this.updateUnitsPreview();
            }


            showFundDetails(fundInfo) {
                document.getElementById('fundName').textContent = fundInfo.name;
                document.getElementById('fundAMC').textContent = fundInfo.amc;
                document.getElementById('fundType').textContent = fundInfo.type;
                document.getElementById('currentNAV').textContent = (fundInfo.currentNAV || 0).toFixed(2);
                document.getElementById('fundDetails').style.display = 'block';
            }

            hideFundDetails() {
                document.getElementById('fundDetails').style.display = 'none';
                this.fundHistoricalData = null;
                this.hideUnitsPreview();
            }

            updateUnitsPreview() {
                const amountInput = document.getElementById('amount');
                if (!this.previewNAV || !amountInput.value || amountInput.value <= 0) {
                    this.hideUnitsPreview();
                    return;
                }
                const amount = parseFloat(amountInput.value);
                const netAmount = amount * (1 - this.STAMP_DUTY_RATE);
                const units = (netAmount / this.previewNAV).toFixed(4);
                const investmentType = document.querySelector('input[name="investmentType"]:checked').value;
                
                document.getElementById('firstPurchaseUnits').style.display = investmentType === 'SIP' ? 'block' : 'none';
                document.getElementById('sipUnitsPreview').style.display = investmentType === 'SIP' ? 'block' : 'none';
                document.getElementById('lumpsumUnitsPreview').style.display = investmentType === 'Lumpsum' ? 'block' : 'none';
                
                if(investmentType === 'SIP'){
                    document.getElementById('firstUnitsValue').textContent = `${units} units`;
                    document.getElementById('firstPurchaseNavDisplay').textContent = this.previewNAV.toFixed(2);
                    const currentNavForSip = parseFloat(this.fundHistoricalData[0].nav);
                    const netSipAmount = amount * (1 - this.STAMP_DUTY_RATE);
                    const sipUnitsFuture = (netSipAmount / currentNavForSip).toFixed(4);
                    document.getElementById('sipUnitsValue').textContent = `${sipUnitsFuture} units`;
                } else {
                    document.getElementById('lumpsumUnitsValue').textContent = `${units} units`;
                    document.getElementById('lumpsumNavDisplay').textContent = this.previewNAV.toFixed(2);
                }

                document.getElementById('unitsPreview').style.display = 'block';
            }
            
            hideUnitsPreview() { document.getElementById('unitsPreview').style.display = 'none'; }
            
            showInstallmentsBreakdown(investment) {
                if (investment.investmentType !== 'SIP' || !investment.installments) {
                    this.hideInstallmentsBreakdown();
                    return;
                }
                const breakdown = document.getElementById('installmentsBreakdown');
                const values = this.calculateInvestmentValue(investment);
                
                document.getElementById('currentTotalUnits').textContent = `${values.totalUnits.toFixed(4)} units`;
                document.getElementById('currentTotalValue').textContent = `â‚¹${values.currentValue.toLocaleString('en-IN')}`;
                
                const installmentsList = document.getElementById('installmentsList');
                installmentsList.innerHTML = investment.installments.map(inst => {
                    const netAmount = inst.amount * (1 - this.STAMP_DUTY_RATE);
                    const units = (netAmount / inst.nav).toFixed(4);
                    return `<div class="installment-item">
                        <span>${new Date(inst.date + 'T00:00:00Z').toLocaleDateString('en-IN', { timeZone: 'UTC' })}</span>
                        <span>â‚¹${inst.amount.toLocaleString('en-IN')} @ ${inst.nav.toFixed(2)}</span>
                        <span>${units} units</span>
                    </div>`;
                }).join('');
                breakdown.style.display = 'block';
            }
            
            hideInstallmentsBreakdown() { document.getElementById('installmentsBreakdown').style.display = 'none'; }

            async saveInvestment() {
                if (!this.fundHistoricalData) {
                    this.showToast('Please fetch fund details first.', 'error');
                    return;
                }
                const amount = parseFloat(document.getElementById('amount').value);
                if (!amount || amount <= 0) {
                    this.showToast('Please enter a valid investment amount', 'error');
                    return;
                }
                
                const investmentType = document.querySelector('input[name="investmentType"]:checked').value;
                let purchaseNAV;
                
                if (investmentType === 'Lumpsum') {
                    const purchaseDate = document.getElementById('purchaseDate').value;
                    if (!purchaseDate) { this.showToast('Please select a purchase date.', 'error'); return; }
                    purchaseNAV = this.getNavForDate(purchaseDate);
                } else { // SIP
                    const firstPurchaseDate = document.getElementById('firstPurchaseDate').value;
                    if (!firstPurchaseDate) { this.showToast('Please select a first purchase date.', 'error'); return; }
                    purchaseNAV = this.getNavForDate(firstPurchaseDate);
                }

                if (!purchaseNAV) {
                    this.showToast('Could not find NAV for the selected date. It might be a holiday.', 'error');
                    return;
                }
                
                const currentNAV = parseFloat(this.fundHistoricalData[0].nav);
                const newInvestment = {
                    id: this.editingId || 'inv_' + Date.now() + Math.random().toString(36).substr(2, 9),
                    amfiCode: document.getElementById('amfiCode').value,
                    fundName: document.getElementById('fundName').textContent,
                    amc: document.getElementById('fundAMC').textContent,
                    fundType: document.getElementById('fundType').textContent,
                    investmentType,
                    amount,
                    purchaseNAV,
                    currentNAV,
                    createdAt: this.editingId ? this.investments.find(inv => inv.id === this.editingId).createdAt : new Date().toISOString()
                };
                
                if (newInvestment.investmentType === 'SIP') {
                    newInvestment.firstPurchaseDate = document.getElementById('firstPurchaseDate').value;
                    newInvestment.sipDate = parseInt(document.getElementById('sipDate').value);
                    newInvestment.frequency = document.getElementById('frequency').value;
                    newInvestment.installments = this.calculateSIPInstallments(newInvestment);
                    if(newInvestment.installments.length === 0) return;
                } else {
                    newInvestment.purchaseDate = document.getElementById('purchaseDate').value;
                }
                
                if (this.editingId) {
                    const index = this.investments.findIndex(inv => inv.id === this.editingId);
                    if (index !== -1) this.investments[index] = newInvestment;
                } else {
                    this.investments.push(newInvestment);
                }
                
                await this._saveData();
                this.closeModal();
                this.showToast(`Investment ${this.editingId ? 'updated' : 'added'} successfully!`, 'success');
            }

            
            calculateSIPInstallments(investment) {
                const installments = [];
                const now = new Date();
                now.setUTCHours(0, 0, 0, 0);
                
                const firstPurchaseDate = new Date(investment.firstPurchaseDate + 'T00:00:00Z');

                // 1. Add the first purchase installment.
                const firstNav = this.getNavForDate(investment.firstPurchaseDate);
                if (!firstNav) {
                    this.showToast(`Could not find NAV for the first purchase date: ${investment.firstPurchaseDate}.`, 'error');
                    return [];
                }
                installments.push({ date: investment.firstPurchaseDate, amount: investment.amount, nav: firstNav });

                // 2. Determine the starting point for the recurring SIP loop.
                const monthsToAdd = investment.frequency === 'monthly' ? 1 : 3;
                let loopDate = new Date(firstPurchaseDate.getTime());
                
                // Set to the first day of the month of the first purchase to begin iteration
                loopDate.setUTCDate(1);

                // 3. Loop through months to find subsequent SIP dates.
                while (true) {
                    // Move to the next potential installment month
                    loopDate.setUTCMonth(loopDate.getUTCMonth() + monthsToAdd);
                    
                    let sipAttemptDate = new Date(Date.UTC(loopDate.getUTCFullYear(), loopDate.getUTCMonth(), investment.sipDate));

                    if (sipAttemptDate > now) break;

                    // We only add if the calculated SIP date is strictly after the initial purchase.
                    if (sipAttemptDate.getTime() > firstPurchaseDate.getTime()) {
                        const dateStr = sipAttemptDate.toISOString().split('T')[0];
                        const installmentNav = this.getNavForDate(dateStr);

                        if (installmentNav) {
                            installments.push({ date: dateStr, amount: investment.amount, nav: installmentNav });
                        } else {
                            console.warn(`NAV not found for past SIP date: ${dateStr}. Skipping installment.`);
                        }
                    }
                    
                    if (installments.length > 360) {
                        console.error("SIP calculation loop exceeded safety limit.");
                        break;
                    }
                }
                
                return installments;
            }


            async refreshAllNAV() {
                this.showLoading('Refreshing all NAVs...');
                for (let investment of this.investments) {
                    try {
                        const response = await fetch(`https://api.mfapi.in/mf/${investment.amfiCode}`);
                        const data = await response.json();
                        if(data && data.data && data.data.length > 0){
                            investment.currentNAV = parseFloat(data.data[0].nav);
                        }
                    } catch (error) {
                        console.error(`Error updating NAV for ${investment.amfiCode}:`, error);
                    }
                }
                await this._saveData();
                this.hideLoading();
                this.showToast('NAV updated successfully!', 'success');
            }

            handleEdit(id) {
                const investment = this.investments.find(inv => inv.id === id);
                if (investment) this.openModal(investment);
            }

            async handleDelete(id) {
                const investment = this.investments.find(inv => inv.id === id);
                if (!investment) return;
                this.openConfirmModal(`Delete investment in "${investment.fundName}"?`, async () => {
                    this.investments = this.investments.filter(inv => inv.id !== id);
                    await this._saveData();
                    this.showToast('Investment deleted.', 'success');
                });
            }
            
            calculateInvestmentValue(investment) {
                const currentNAV = investment.currentNAV || investment.purchaseNAV;
                let totalInvested = 0, totalUnits = 0;
                const cashFlows = [], dates = [];
                
                if (investment.investmentType === 'SIP' && investment.installments) {
                    investment.installments.forEach(inst => {
                        totalInvested += inst.amount;
                        const netAmount = inst.amount * (1 - this.STAMP_DUTY_RATE);
                        totalUnits += netAmount / inst.nav;
                        cashFlows.push(-inst.amount);
                        dates.push(inst.date);
                    });
                } else { // Lumpsum
                    totalInvested = investment.amount;
                    const netAmount = investment.amount * (1 - this.STAMP_DUTY_RATE);
                    totalUnits = netAmount / investment.purchaseNAV;
                    cashFlows.push(-totalInvested);
                    dates.push(investment.purchaseDate);
                }
                
                const currentValue = totalUnits * currentNAV;
                const pnl = currentValue - totalInvested;
                const pnlPercent = totalInvested > 0 ? (pnl / totalInvested) * 100 : 0;

                let xirr = 0;
                if (cashFlows.length > 1) { // XIRR needs at least one investment and the current value
                    cashFlows.push(currentValue);
                    dates.push(new Date().toISOString().split('T')[0]);
                    xirr = this.calculateXIRR(cashFlows, dates);
                }
                
                return { totalInvested, currentValue, totalUnits, pnl, pnlPercent, xirr };
            }
            
            calculateXIRR(cashFlows, dates, guess = 0.1) {
                if (cashFlows.length !== dates.length || cashFlows.length < 2) return 0;

                const daysDiff = dates.map(date => (new Date(date) - new Date(dates[0])) / (1000 * 60 * 60 * 24));

                const F = (rate) => cashFlows.reduce((acc, val, i) => acc + val / Math.pow(1 + rate, daysDiff[i] / 365), 0);
                const F_prime = (rate) => cashFlows.reduce((acc, val, i) => acc - (val * daysDiff[i]) / (365 * Math.pow(1 + rate, (daysDiff[i] / 365) + 1)), 0);

                let rate = guess;
                for (let i = 0; i < 50; i++) {
                    const f_val = F(rate);
                    const f_prime_val = F_prime(rate);
                    if (Math.abs(f_prime_val) < 1e-9) break;
                    const newRate = rate - f_val / f_prime_val;
                    if (Math.abs(newRate - rate) < 1e-9) return newRate * 100;
                    rate = newRate;
                }
                return 0; // Failed to converge
            }


            renderInvestments() {
                const grid = document.getElementById('investmentsGrid');
                const emptyState = document.getElementById('emptyState');
                
                if (this.filteredInvestments.length === 0) {
                    grid.innerHTML = '';
                    grid.style.display = 'none';
                    emptyState.style.display = 'block';

                    if (this.investments.length === 0) {
                        emptyState.querySelector('h3').textContent = 'No Investments Yet';
                        emptyState.querySelector('p').textContent = 'Add your first investment to start tracking your portfolio';
                        emptyState.querySelector('.empty-icon').textContent = 'ðŸ“Š';
                    } else {
                        emptyState.querySelector('h3').textContent = 'No Matching Investments';
                        emptyState.querySelector('p').textContent = 'Try adjusting your search or filter criteria';
                        emptyState.querySelector('.empty-icon').textContent = 'ðŸ”';
                    }
                    return;
                }
                
                emptyState.style.display = 'none';
                grid.style.display = 'grid';
                grid.innerHTML = this.filteredInvestments.map(inv => {
                    const values = this.calculateInvestmentValue(inv);
                    const pnlClass = values.pnl >= 0 ? 'positive' : 'negative';
                    return `
                    <div class="investment-card" data-id="${inv.id}">
                        <div class="investment-header">
                            <div class="investment-info">
                                <h4>${inv.fundName}</h4>
                                <div class="investment-meta">
                                    <span>${inv.amc}</span>
                                    <span class="badge badge--${inv.investmentType.toLowerCase()}">${inv.investmentType}</span>
                                </div>
                            </div>
                            <div class="investment-actions">
                                <button class="btn btn--outline btn--sm js-edit-btn">Edit</button>
                                <button class="btn btn--outline btn--sm js-delete-btn" style="color: var(--color-error);">Delete</button>
                            </div>
                        </div>
                        <div class="investment-stats">
                            <div class="stat-item"><div class="stat-label">Units</div><div class="stat-value">${values.totalUnits.toFixed(4)}</div></div>
                            <div class="stat-item"><div class="stat-label">Invested</div><div class="stat-value">â‚¹${values.totalInvested.toLocaleString('en-IN')}</div></div>
                            <div class="stat-item"><div class="stat-label">Current Value</div><div class="stat-value">â‚¹${values.currentValue.toLocaleString('en-IN')}</div></div>
                            <div class="stat-item"><div class="stat-label">P&L</div><div class="stat-value ${pnlClass}">â‚¹${values.pnl.toLocaleString('en-IN')}</div></div>
                            <div class="stat-item"><div class="stat-label">P&L %</div><div class="stat-value ${pnlClass}">${values.pnlPercent.toFixed(2)}%</div></div>
                            <div class="stat-item"><div class="stat-label">XIRR</div><div class="stat-value ${pnlClass}">${values.xirr.toFixed(2)}%</div></div>
                        </div>
                    </div>`;
                }).join('');
            }

            updateSummary() {
                let totalInvested = 0, totalCurrentValue = 0;
                const portfolioCashFlows = [], portfolioDates = [];

                this.investments.forEach(inv => {
                    const values = this.calculateInvestmentValue(inv);
                    totalInvested += values.totalInvested;
                    totalCurrentValue += values.currentValue;

                    if (inv.investmentType === 'SIP' && inv.installments) {
                        inv.installments.forEach(inst => {
                            portfolioCashFlows.push(-inst.amount);
                            portfolioDates.push(inst.date);
                        });
                    } else {
                        portfolioCashFlows.push(-inv.amount);
                        portfolioDates.push(inv.purchaseDate);
                    }
                });
                
                const totalPL = totalCurrentValue - totalInvested;
                const totalPLPercent = totalInvested > 0 ? (totalPL / totalInvested) * 100 : 0;
                
                let portfolioXIRR = 0;
                if (portfolioCashFlows.length > 1 && totalCurrentValue > 0) {
                    portfolioCashFlows.push(totalCurrentValue);
                    portfolioDates.push(new Date().toISOString().split('T')[0]);
                    portfolioXIRR = this.calculateXIRR(portfolioCashFlows, portfolioDates);
                }

                document.getElementById('totalInvested').textContent = `â‚¹${totalInvested.toLocaleString('en-IN')}`;
                document.getElementById('currentValue').textContent = `â‚¹${totalCurrentValue.toLocaleString('en-IN')}`;
                document.getElementById('totalPL').textContent = `â‚¹${totalPL.toLocaleString('en-IN')}`;
                document.getElementById('totalPLPercent').textContent = `${totalPLPercent.toFixed(2)}%`;
                document.getElementById('totalXIRR').textContent = `${portfolioXIRR.toFixed(2)}%`;


                ['totalPL', 'totalPLPercent', 'totalXIRR'].forEach(id => {
                    const el = document.getElementById(id);
                    const value = id === 'totalXIRR' ? portfolioXIRR : totalPL;
                    el.classList.toggle('positive', value >= 0);
                    el.classList.toggle('negative', value < 0);
                });
            }

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.investments));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "mf_investments.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                this.showToast('Data exported successfully!', 'success');
            }

            async importData(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            this.investments = data;
                            await this._saveData();
                            this.showToast('Data imported successfully!', 'success');
                        } else { throw new Error('Invalid file format'); }
                    } catch (error) { this.showToast('Error importing data.', 'error'); }
                };
                reader.readAsText(file);
            }

            showLoading(message = 'Loading...') {
                document.getElementById('loadingOverlay').querySelector('p').textContent = message;
                document.getElementById('loadingOverlay').classList.add('active');
            }
            hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }

            showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<div class="toast-content"><span>${message}</span></div>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    if(toast.parentElement) {
                    setTimeout(() => container.removeChild(toast), 300);
                    }
                }, 3000);
            }

            applyFilters() {
                this.filteredInvestments = this.investments.filter(inv => {
                    const searchMatch = !this.filters.search || 
                        inv.fundName.toLowerCase().includes(this.filters.search.toLowerCase()) ||
                        inv.amc.toLowerCase().includes(this.filters.search.toLowerCase());
                    const typeMatch = !this.filters.type || inv.investmentType === this.filters.type;
                    const categoryMatch = !this.filters.category || inv.fundType.includes(this.filters.category);
                    const amcMatch = !this.filters.amc || inv.amc === this.filters.amc;
                    return searchMatch && typeMatch && categoryMatch && amcMatch;
                });
                this.renderInvestments();
                this.updateActiveFilters();
                this.updateResultsCount();
            }
            
            updateActiveFilters() {
                const container = document.getElementById('activeFilters');
                const chips = [];
                if (this.filters.search) chips.push({type: 'search', label: `Search: "${this.filters.search}"`});
                if (this.filters.type) chips.push({type: 'type', label: `Type: ${this.filters.type}`});
                if (this.filters.category) chips.push({type: 'category', label: `Category: ${this.filters.category}`});
                if (this.filters.amc) chips.push({type: 'amc', label: `AMC: ${this.filters.amc}`});

                if(chips.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                container.style.display = 'flex';
                container.innerHTML = chips.map(chip => `<div class="filter-chip"><span>${chip.label}</span><button class="filter-chip-remove" data-filter-type="${chip.type}">&times;</button></div>`).join('');
                
                container.querySelectorAll('.filter-chip-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => this.removeFilter(e.target.dataset.filterType));
                });
            }
            
            removeFilter(filterType) {
                if (filterType === 'search') {
                    document.getElementById('searchInput').value = '';
                    this.filters.search = '';
                    this.toggleClearSearch();
                } else {
                    document.getElementById(`${filterType}Filter`).value = '';
                    this.filters[filterType] = '';
                }
                this.applyFilters();
            }
            
            clearAllFilters() {
                this.filters = { search: '', type: '', category: '', amc: '' };
                document.getElementById('searchInput').value = '';
                document.getElementById('typeFilter').value = '';
                document.getElementById('categoryFilter').value = '';
                document.getElementById('amcFilter').value = '';
                this.toggleClearSearch();
                this.applyFilters();
            }
            
            toggleClearSearch() {
                document.getElementById('clearSearch').style.display = document.getElementById('searchInput').value ? 'block' : 'none';
            }
            
            updateAMCFilter() {
                const amcFilter = document.getElementById('amcFilter');
                const uniqueAMCs = [...new Set(this.investments.map(inv => inv.amc))].sort();
                const currentValue = amcFilter.value;
                amcFilter.innerHTML = '<option value="">All AMCs</option>' + uniqueAMCs.map(amc => `<option value="${amc}">${amc}</option>`).join('');
                if (currentValue) amcFilter.value = currentValue;
            }
            
            updateResultsCount() {
                const el = document.getElementById('resultsCount');
                const total = this.investments.length;
                const filtered = this.filteredInvestments.length;
                if (total === 0) el.textContent = '';
                else if (filtered === total) el.textContent = `Showing all ${total} investments.`;
                else el.textContent = `Showing ${filtered} of ${total} investments.`;
            }
        }
        
        // --- Firebase Initialization and App Start ---
        function initializeAppAndAuth() {
            let app, auth, db;
            
            const finalFirebaseConfig = typeof __firebase_config !== 'undefined' 
                ? JSON.parse(__firebase_config) 
                : firebaseConfig;

            try {
                app = initializeApp(finalFirebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.body.innerHTML = '<h1>Error: Could not connect to the database. Please check your Firebase configuration.</h1>';
                return;
            }

            const appInstance = new InvestmentTracker();
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const userProfile = document.getElementById('user-profile');
            const userName = document.getElementById('user-name');

            const handleLogin = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    // onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                    appInstance.showToast("Could not sign in with Google.", "error");
                }
            };

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error("Sign out failed:", error);
                }
            };
            
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    authContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    userName.textContent = user.displayName || 'User';
                    userProfile.style.display = 'flex';
                    
                    if (appInstance.userId !== user.uid) { // Initialize or re-initialize if user changes
                       await appInstance.init(db, user);
                    }
                } else {
                    // User is signed out
                    appContainer.style.display = 'none';
                    authContainer.style.display = 'flex';
                    userProfile.style.display = 'none';
                    if (appInstance.unsubscribe) {
                        appInstance.unsubscribe();
                        appInstance.unsubscribe = null;
                        appInstance.investments = [];
                        appInstance.applyFilters();
                        appInstance.updateSummary();
                    }
                }
            });
        }

        window.addEventListener('load', initializeAppAndAuth);

    </script>
</body>
</html>

